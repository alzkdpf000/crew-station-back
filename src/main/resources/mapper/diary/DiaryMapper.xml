<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.crewstation.mapper.diary.DiaryMapper">
    <select id="selectDiaryList">
        select
            vpd.id                as diaryId,
            vpd.member_id         as memberId,
            vpd.updated_datetime  as updatedDatetime,
            vpd.created_datetime  as createdDatetime,
            vpd.diary_like_count  as diaryLikeCount,
            vpd.diary_reply_count as diaryReplyCount,
            m.member_name         as memberName,
            m.member_description  as memberDescription,
            m.social_img_url      as socialImgUrl,
            ps.post_content       as postContent,
            coalesce(
                -- 1) 다이어리에 매핑된 main 이미지
                    (select f.file_path
                     from tbl_post_section ps2
                              join tbl_post_section_file psf2 on psf2.post_section_id = ps2.id
                              join tbl_file f on f.id = psf2.file_id
                     where ps2.post_id = vpd.id
                       and psf2.image_type = 'main'
                     limit 1),
                -- 2) 다이어리에 매핑된 아무 파일 1장
                    (select f.file_path
                     from tbl_post_section ps3
                              join tbl_post_section_file psf3 on psf3.post_section_id = ps3.id
                              join tbl_file f on f.id = psf3.file_id
                     where ps3.post_id = vpd.id
                     limit 1),
                -- 3) 작성자 프로필 이미지
                    m.social_img_url,
                -- 4) 기본 이미지(프로젝트 내 정적 파일)
                    '/images/diary-default.png'
            ) as filePath
        from view_post_diary vpd
                 join tbl_member m on vpd.member_id = m.id
                 join tbl_post_section ps on ps.post_id = vpd.id
        where vpd.diary_secret = 'public'
        order by vpd.created_datetime desc
        limit 4;

    </select>

    <!-- 내가 좋아요 한 일기 -->
    <select id="findDiariesLikedByMemberId" resultType="com.example.crewstation.dto.diary.LikedDiaryDTO">
        SELECT d.post_id AS postId,
               p.post_title,
               m.id            AS memberId,
               m.member_name   AS memberName,
               m.social_img_url AS memberProfileImage,

               f.file_path AS mainImage,

               (SELECT ps.post_content
                FROM tbl_post_section ps
                WHERE ps.post_id = p.id
                ORDER BY ps.id ASC
                LIMIT 1) AS content,

               d.diary_like_count,
               d.diary_reply_count,

               1 AS liked
        FROM tbl_like l
                 JOIN tbl_post p ON l.post_id = p.id
                 JOIN tbl_diary d ON d.post_id = p.id
                 JOIN tbl_member m ON p.member_id = m.id
                 LEFT JOIN (
            SELECT ps.post_id, COALESCE(main.file_id, sub.first_file_id) AS first_file_id
            FROM tbl_post_section ps
                     LEFT JOIN (
                SELECT psf.post_section_id, MIN(f.id) AS file_id
                FROM tbl_post_section_file psf
                         JOIN tbl_file f ON psf.file_id = f.id
                WHERE psf.image_type = 'main'
                GROUP BY psf.post_section_id
            ) main ON ps.id = main.post_section_id
                     LEFT JOIN (
                SELECT psf.post_section_id, MIN(f.id) AS first_file_id
                FROM tbl_post_section_file psf
                         JOIN tbl_file f ON psf.file_id = f.id
                WHERE psf.image_type = 'sub'
                GROUP BY psf.post_section_id
            ) sub ON ps.id = sub.post_section_id
        ) sec_file ON p.id = sec_file.post_id
                 LEFT JOIN tbl_file f ON sec_file.first_file_id = f.id
        WHERE l.member_id = #{memberId}
        ORDER BY l.id DESC
        LIMIT #{criteria.size} OFFSET #{criteria.offset}
    </select>

    <!-- 좋아요 취소 -->
    <delete id="deleteLike">
        DELETE FROM tbl_like
        WHERE member_id = #{memberId}
          AND post_id = #{diaryId}
    </delete>

    <!-- 내가 좋아요 한 일기 개수 -->
    <select id="countDiariesLikedByMemberId" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM tbl_like
        WHERE member_id = #{memberId}
    </select>


    <!-- 내가 댓글 단 일기 조회 -->
    <select id="selectReplyDiariesByMemberId" resultType="com.example.crewstation.dto.diary.ReplyDiaryDTO">
        SELECT
            p.id                   AS postId,
            p.post_title           AS postTitle,
            ps.post_content        AS content,
            f.file_path            AS mainImage,
            r.reply_content        AS replyContent,
            r.created_datetime     AS createdDatetime
        FROM tbl_reply r
                 JOIN tbl_diary d ON r.diary_id = d.post_id
                 JOIN tbl_post p  ON d.post_id = p.id
                 LEFT JOIN tbl_post_section ps
                           ON p.id = ps.post_id
                 LEFT JOIN tbl_post_section_file psf
                           ON ps.id = psf.post_section_id
                               AND psf.image_type = 'main'
                 LEFT JOIN tbl_file f
                           ON psf.file_id = f.id
        WHERE r.member_id = #{memberId}
        ORDER BY r.created_datetime DESC
        LIMIT #{criteria.size} OFFSET #{criteria.offset}
    </select>

    <select id="countReplyDiariesByMemberId" resultType="int">
        SELECT COUNT(*)
        FROM tbl_reply r
        WHERE r.member_id = #{memberId}
    </select>

</mapper>