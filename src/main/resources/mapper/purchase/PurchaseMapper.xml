<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.crewstation.mapper.purchase.PurchaseMapper">
    <sql id="giftSearch">
        <where>
            <if test="search.keyword != null and search.keyword != ''">
                (
                vpp.purchase_country like '%' || #{search.keyword} || '%'
                or vpp.post_title like '%' || #{search.keyword} || '%'
                )
            </if>
        </where>
    </sql>
    <select id="selectAllByKeyWord">
        select vpp.id as post_id,
        vpp.post_title,
        vpp.purchase_country,
        vpp.purchase_delivery_method,
        vpp.purchase_limit_time,
        vpp.purchase_product_count,
        vpp.purchase_product_price,
        vpp.purchase_delivery_method,
        vpp.created_datetime,
        vpp.updated_datetime,
        vfps.file_path,
        vfps.file_name,
        tm.member_name,
        tm.chemistry_score
        from tbl_member tm join
        view_post_purchase vpp on tm.id = vpp.member_id
        join tbl_post_section tps on vpp.id = tps.post_id and vpp.post_status = 'active'
        join view_file_post_section_file vfps on tps.id = vfps.post_section_id and vfps.image_type = 'main'
        <include refid="giftSearch"/>
        limit #{criteria.rowCount} offset #{criteria.offset}
    </select>

    <select id="selectCountAllByKeyWord">
        select count(vpp.id)
        from view_post_purchase vpp
        join tbl_post_section tps on vpp.id = tps.post_id and vpp.post_status = 'active'
        join view_file_post_section_file vfps on tps.id = vfps.post_section_id and vfps.image_type = 'main'
        <include refid="giftSearch"/>
    </select>
</mapper>